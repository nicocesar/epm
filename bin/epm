#!/usr/bin/env ruby

require File.join(File.dirname(__FILE__), '..', 'lib', 'epm.rb')
require 'commander/import'

program :version, EPM.version
program :description, 'Ethereum Package Manager assists in the management of Ethereum Packages and Tools to ease developers workflows.'

##
## Package Workflow Commands
##
command :compile do |c|
  c.syntax = 'epm compile'
  # summary is displayed on --help
  c.summary = 'Compile an ethereum contract and return the byte code array.'
  # description is deplayed on subcommand --help
  c.description = 'Compile an ethereum contract and return the byte code array.'
  c.action do |args|
    result = EPM.compile(args)
    result.each{|l| print l + "\n"}
  end
end

command :create do |c|
  c.syntax = 'epm create'
  # summary is displayed on --help
  c.summary = 'Compile an ethereum contract and deploy to the blockchain.'
  # description is deplayed on subcommand --help
  c.description = 'Compile an ethereum contract and deploy to the blockchain.'
  c.action do |args|
    result = EPM.create(args)
    result.each{|l| print l + "\n"}
  end
end

command :deploy do |c|
  c.syntax = 'epm deploy'
  # summary is displayed on --help
  c.summary = 'Compile and deploy a system of contracts to the blockchain.'
  # description is deplayed on subcommand --help
  c.description = 'Compile and deploy a system of contracts to the blockchain. See gem README for EPM package-definition file syntax.'
  c.action do |args|
    EPM.deploy(args)
  end
end

##
## EPM Tools
##
command :transact do |c|
  c.syntax = 'epm transact'
  # summary is displayed on --help
  c.summary = 'Send a transaction to a contract.'
  # description is deplayed on subcommand --help
  c.description = 'Send a transaction to a contract. Note this is to work with contracts, it will not (by default) send ether.'
  c.action do |args|
    EPM.transact(args)
    print "Transaction Sent.\n"
  end
end

command :query do |c|
  c.syntax = 'epm query'
  # summary is displayed on --help
  c.summary = 'Query a storage position of a contract currently on the blockchain.'
  # description is deplayed on subcommand --help
  c.description = 'Query a storage position of a contract currently on the blockchain.'
  c.action do |args|
    print EPM.query(args) + "\n"
  end
end

command :rpc do |c|
  c.syntax = 'epm rpc [method] [...args...]'
  c.description = 'Connect to eth and send any RPC command.'
  c.option '--a ADDRESS', String, 'Some address.'
  c.option '--x VALUE', String, 'Some value.'
  c.option '--s STRING', String, 'Some string, for lll, lll code.'
  c.option '--aDest ADDRESS', String, 'Destination address.'
  c.option '--bData HEX', String, 'Hex data.'
  c.option '--sec HEX', String, 'Private key. (yikes! chill, its testnet)'
  c.option '--xGas VALUE', String, 'Gas budget.'
  c.option '--xGasPrice VALUE', String, 'Gas price offered.'
  c.option '--xValue VALUE', String, 'ethers along with transaction.'
  c.option '--bCode HEX', String, 'Binary code as hex value.'
  c.option '--xEndowment VALUE', String, 'Ethers to give a created contract.'
  c.action do |args, opts|
    print "#{EPM.rpc args, opts}\n"
  end
end

command :start do |c|
  c.syntax = 'epm start'
  c.description = 'Start your default ethereum server.'
  c.action do
    print "Please be patient, this will take a few seconds.\n"
    EPM.start
    print "Server has started.\n"
  end
end

command :stop do |c|
  c.syntax = 'epm stop'
  c.description = 'Stop your default ethereum server.'
  c.action do
    EPM.stop
    print "Server has stopped.\n"
  end
end

command :restart do |c|
  c.syntax = 'epm restart'
  c.summary = ''
  c.description = 'Restart your default ethereum server.'
  c.action do
    print "Please be patient, this will take a few seconds.\n"
    EPM.restart
    print "Server has been restarted.\n"
  end
end
